generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite" // Cambiar a "postgresql" si migrás a Postgres
  url      = env("DATABASE_URL")
}

model Patient {
  id             String   @id @default(cuid())
  dni            String   @unique
  firstName      String
  lastName       String
  birthDate      DateTime
  sex            String // "F" | "M" | "X"
  phone          String?
  email          String?  @unique
  address        String?
  obraSocial     String?
  codigoAfiliado String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  orders TestOrder[]
}

model Doctor {
  id            String  @id @default(cuid())
  fullName      String
  licenseNumber String? @unique
  phone         String?
  email         String? @unique

  orders TestOrder[]
}

model TestOrder {
  id          String   @id @default(cuid())
  patientId   String
  doctorId    String?
  status      String   @default("PENDIENTE") // PENDING | COMPLETED | CANCELED
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt
  notes       String?
  orderNumber String?  @unique
  title       String?

  patient Patient @relation(fields: [patientId], references: [id])
  doctor  Doctor? @relation(fields: [doctorId], references: [id])

  items   OrderItem[]
  samples Sample[]
}

model Sample {
  id          String    @id @default(cuid())
  orderId     String
  sampleType  String // BLOOD | URINE | STOOL | SALIVA | OTHER
  collectedAt DateTime?
  notes       String?

  order TestOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
}

model Result {
  id          String   @id @default(cuid())
  orderItemId String   @unique
  value       String
  observedAt  DateTime @default(now())
  unit        String?
  refRange    String?

  orderItem OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)

  @@index([orderItemId])
}

model User {
  id           String   @id @default(cuid())
  username     String   @unique
  passwordHash String
  role         String   @default("OPERATOR") // ADMIN | OPERATOR | VIEWER
  createdAt    DateTime @default(now())
}

model Nomenclador {
  id            String @id @default(cuid())
  codigo        Int    @unique // ej: 660002
  determinacion String // ej: ACETONURIA
  ub            Float // ej: 1, 3, 12.5

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Cada código (660042, etc.)
model ExamType {
  id      String  @id @default(cuid())
  code    String  @unique
  name    String
  isPanel Boolean @default(false)

  items      ExamItemDef[]
  orderItems OrderItem[]
}

// Definición de los ítems a completar para un código (nombre/unidad fijos)
model ExamItemDef {
  id         String   @id @default(cuid())
  examTypeId String
  examType   ExamType @relation(fields: [examTypeId], references: [id], onDelete: Cascade)

  key   String // identificador interno
  label String // etiqueta visible
  unit  String? // "U/L"

  sortOrder Int      @default(0)
  refText   String? // “0.70–1.20 mg/dL”, “Negativo”, “No reactivas”, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  kind          String?
  analytes      OrderItemAnalyte[]
  ExamItemRange ExamItemRange[]

  @@unique([examTypeId, key])
}

// Reglas de referencia (sexo/edad, extensible)
model ExamItemRange {
  id     String      @id @default(cuid())
  itemId String
  item   ExamItemDef @relation(fields: [itemId], references: [id], onDelete: Cascade)

  sex        String? // "F" | "M" | "X" | null = cualquiera
  minAgeDays Int? // edad mínima en días
  maxAgeDays Int? // edad máxima en días

  // Para NUMERIC
  low  Float?
  high Float?

  // Para TEXT/ENUM
  expectedText String?

  note String?
}

// Instancia de un código dentro de una orden
model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  examTypeId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  order    TestOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  examType ExamType  @relation(fields: [examTypeId], references: [id])

  analytes OrderItemAnalyte[]
  results  Result[]
}

// Resultado por sub-ítem (instancias a completar en esa orden)
model OrderItemAnalyte {
  id          String @id @default(cuid())
  orderItemId String
  itemDefId   String

  orderItem OrderItem   @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  itemDef   ExamItemDef @relation(fields: [itemDefId], references: [id])

  // valor cargado
  valueNum  Float?
  valueText String?
  status    String  @default("PENDING") // "PENDING"|"DONE"
  comment   String?

  // snapshot de unidad y referencias al momento de crear la orden
  unit        String?
  refLow      Float?
  refHigh     Float?
  refExpected String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([orderItemId])
  @@index([itemDefId])
}
